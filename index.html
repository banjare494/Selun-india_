<!DOCTYPE html>
<html lang="hi" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Salon India ‚Ä¢ Register ‚Ä¢ List ‚Ä¢ Book</title>

  <meta name="title" content="Salon India - Register ‚Ä¢ List ‚Ä¢ Book Salon">
  <meta name="description" content="Salon India: register salon, price list set karein, WhatsApp/UPI se booking lein. Free, fast & simple.">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://banjare494.github.io/Selun-india_/">
  <meta property="og:title" content="Salon India ‚Äì Free Salon Register & Booking Platform">
  <meta property="og:description" content="Apna salon register karo, list banao, booking lo ‚Äì maps, UPI & dashboard ke saath!">
  <meta property="og:image" content="https://banjare494.github.io/Selun-india_/images/banner.jpg">
  <meta property="og:url" content="https://banjare494.github.io/Selun-india_/">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="theme-color" content="#0078ff">

  <link rel="manifest" href="manifest.json">

  <style>
    :root{
      --bg:#0f172a;--bg-soft:#111827;--card:#0b1020;--text:#e5e7eb;--muted:#9ca3af;
      --brand:#3b82f6;--brand-2:#8b5cf6;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;
      --ring:0 0 0 6px rgba(59,130,246,.15);--shadow:0 12px 30px rgba(0,0,0,.35);
      --radius:18px;--radius-lg:28px;
    }
    [data-theme="light"]{--bg:#f6f9fc;--bg-soft:#eef2f7;--card:#fff;--text:#111827;--muted:#667085;--shadow:0 14px 36px rgba(2,10,40,.10)}
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:inherit;text-decoration:none} img{display:block;max-width:100%}
    .wrap{max-width:1080px;margin:0 auto;padding:18px}

    header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(1.3) blur(10px);
      background:linear-gradient(180deg, rgba(15,23,42,.75), rgba(15,23,42,.55));
      border-bottom:1px solid rgba(255,255,255,.06)}
    [data-theme="light"] header{background:rgba(255,255,255,.78);border-bottom:1px solid #e5e7eb}
    .nav{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 18px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px}
    .brand .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand-2));box-shadow:0 8px 20px rgba(59,130,246,.35);display:grid;place-items:center;color:#fff}
    .brand span{font-size:20px}
    .navlinks{display:flex;gap:8px;align-items:center}
    .btn{background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;border:0;border-radius:14px;padding:10px 14px;font-weight:800;cursor:pointer;box-shadow:var(--shadow);transition:transform .06s ease}
    .btn:active{transform:translateY(1px)}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.14)}
    [data-theme="light"] .btn.ghost{border-color:#e5e7eb}
    .btn.small{padding:7px 9px;font-weight:700;border-radius:10px}

    .hero{position:relative;isolation:isolate}
    .hero .bg{height:300px;border-radius:0 0 var(--radius-lg) var(--radius-lg);
      background:radial-gradient(80% 60% at 10% 10%, rgba(59,130,246,.45), transparent 60%),
                 radial-gradient(60% 50% at 90% 20%, rgba(139,92,246,.40), transparent 60%),
                 linear-gradient(180deg,#020617,#0b1020);overflow:hidden}
    [data-theme="light"] .hero .bg{background:linear-gradient(180deg,#fff,#eef2ff)}
    .hero img.banner{width:100%;height:100%;object-fit:cover;opacity:.18;mix-blend:overlay}
    .hero .headline{position:absolute;inset:0;display:grid;place-items:center;padding:0 16px;text-align:center}
    .hero h1{font-size:clamp(26px,4vw,44px);line-height:1.1}
    .hero p{color:var(--muted);margin-top:10px}

    .grid{display:grid;gap:16px}
    @media(min-width:860px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    [data-theme="light"] .card{border:1px solid #e5e7eb}
    .h2{font-size:18px;font-weight:900;margin-bottom:10px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input,select,textarea{width:100%;padding:12px 14px;border:1px solid rgba(255,255,255,.14);border-radius:12px;background:rgba(255,255,255,.03);color:inherit;outline:none}
    input::placeholder,textarea::placeholder{color:var(--muted)}
    input:focus,select:focus,textarea:focus{box-shadow:var(--ring);border-color:transparent}
    [data-theme="light"] input,[data-theme="light"] select,[data-theme="light"] textarea{background:#fff;border:1px solid #e5e7eb}
    .list{display:grid;gap:12px}
    @media(min-width:720px){.list{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .item{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);padding:16px;display:grid;gap:10px;box-shadow:var(--shadow)}
    [data-theme="light"] .item{border:1px solid #e5e7eb}
    .badges{display:flex;gap:6px;flex-wrap:wrap}
    .tag{font-size:12px;background:rgba(59,130,246,.12);color:#dbeafe;border:1px solid rgba(59,130,246,.25);border-radius:999px;padding:4px 8px}
    [data-theme="light"] .tag{color:#1f3bb3;background:#edf2ff;border:1px solid #dbe5ff}
    .thumb{width:86px;height:86px;border-radius:12px;object-fit:cover;border:1px solid rgba(255,255,255,.12)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .sp{height:16px}
    footer{text-align:center;padding:22px;background:var(--card);border-top:1px solid rgba(255,255,255,.08);margin-top:18px}
    [data-theme="light"] footer{border-top:1px solid #e5e7eb}
    .toast{position:fixed;right:16px;bottom:16px;z-index:100;background:var(--card);border:1px solid rgba(255,255,255,.12);padding:12px 14px;border-radius:14px;box-shadow:var(--shadow);min-width:240px}
    .hide{display:none !important}
    .sr{position:absolute;left:-9999px}
    .star{font-size:22px;cursor:pointer}

    /* Booking calendar */
    .slots{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
    .slot{border:1px solid rgba(255,255,255,.18);padding:10px;border-radius:10px;text-align:center;cursor:pointer}
    .slot.sel{outline:2px solid var(--brand)}
    .slot.dis{opacity:.45;pointer-events:none}
    [data-theme="light"] .slot{border-color:#e5e7eb}

    /* Map embed (fix) */
    .mapBox{border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.12)}
    [data-theme="light"] .mapBox{border-color:#e5e7eb}

    /* Admin */
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    @media(max-width:820px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .kpi{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    [data-theme="light"] .kpi{border-color:#e5e7eb}
    .kpi .val{font-size:22px;font-weight:900}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.12);text-align:left}
    [data-theme="light"] th,[data-theme="light"] td{border-color:#e5e7eb}
    th{font-weight:800}
  </style>
</head>
<body>
  <header>
    <div class="nav wrap">
      <a class="brand" href="#home" aria-label="Salon India Home">
        <div class="logo">üíà</div><span data-i18n="brand">Salon India</span>
      </a>
      <nav class="navlinks">
        <a href="#profile" class="btn ghost" title="Profile">üë§</a>
        <a href="#admin" class="btn ghost" title="Dashboard">üìä</a>
        <button id="langBtn" class="btn ghost" title="Language">EN/HI</button>
        <button id="loginBtn" class="btn ghost" title="Owner Login">üîê</button>
        <button id="themeBtn" class="btn ghost" title="Dark / Light">üåó</button>
      </nav>
    </div>
  </header>

  <section id="home" class="hero">
    <div class="bg">
      <img class="banner" src="https://images.unsplash.com/photo-1512690459411-b9245aed614b?q=80&w=1600&auto=format&fit=crop" alt="Salon banner">
    </div>
    <div class="headline wrap">
      <div>
        <h1 data-i18n="heroTitle">Register ‚Ä¢ List ‚Ä¢ Book ‚Äî Premium, fast & free</h1>
        <p data-i18n="heroSub">Owners apna page register karein, prices set karein, aur customers WhatsApp/UPI se booking karein.</p>
      </div>
    </div>
  </section>

  <section id="about" class="wrap" style="margin-top:18px">
    <div class="grid">
      <div class="card">
        <div class="h2" data-i18n="aboutTitle">Bharat ke salon owners ke liye smart platform</div>
        <p class="muted" data-i18n="aboutSub">Koi complicated app nahi. Sirf form bhariye aur turant listing ready.</p>
        <div class="sp"></div>
        <ul class="muted" style="display:grid;gap:6px;list-style:none">
          <li>‚úÖ <span data-i18n="feat1">Short link, prices, ratings, photo, WhatsApp</span></li>
          <li>‚úÖ <span data-i18n="feat2">Live City filter & Owner login</span></li>
          <li>‚úÖ <span data-i18n="feat3">Detail Page + Calendar + üìç Maps</span></li>
          <li>‚úÖ <span data-i18n="feat4">PWA Install (Android App)</span></li>
          <li>‚úÖ <span data-i18n="feat5">UPI Advance Payment</span></li>
          <li>üÜï <span data-i18n="feat6">Customer Profile & Booking history</span></li>
          <li>üÜï <span data-i18n="feat7">SEO Dashboard</span></li>
        </ul>
        <div class="sp"></div>
        <div class="row">
          <a class="btn" href="#register" data-i18n="ctaRegister">+ Register</a>
          <a class="btn ghost" href="#list" data-i18n="ctaBrowse">üîé Browse</a>
        </div>
      </div>
    </div>
  </section>

  <section id="register" class="wrap" style="margin-top:18px">
    <div class="h2" data-i18n="ownerRegister">üìù Owner Register</div>
    <div class="card">
      <div class="row">
        <input id="owner"  placeholder="Owner Name" autocomplete="name">
        <input id="mobile" placeholder="Mobile (10-digit ya 91XXXXXXXXXX)" inputmode="numeric" maxlength="12" autocomplete="tel">
        <input id="salonName" type="text" placeholder="Salon Name" required>

        <input id="slug" type="text" placeholder="Short Link (slug) ‚Äî e.g., kamlesh-salon" inputmode="latin" pattern="[a-z0-9\-]{3,}" title="sirf a-z, 0-9 aur hyphen (-)" required>
        <small id="slugHelp" style="display:block;margin-top:6px;color:var(--muted);font-size:12px;">Short link auto ban raha hai. Sirf a-z, 0-9, ‚Äú-‚Äù.</small>

        <input id="city" placeholder="City / Area" autocomplete="address-level2">

        <label class="btn ghost" for="photo" style="display:inline-grid;place-items:center;cursor:pointer">üì∑ Upload photo</label>
        <input id="photo" class="sr" type="file" accept="image/*">
        <img id="photoPrev" class="thumb hide" alt="Preview">

        <input id="addr" placeholder="Address (optional)">
        <div class="row">
          <input id="lat" placeholder="Latitude (e.g., 21.2513)" inputmode="decimal">
          <input id="lng" placeholder="Longitude (e.g., 81.6296)" inputmode="decimal">
          <button id="gpsBtn" type="button" class="btn ghost">üìç Use GPS</button>
        </div>

        <input id="upi" placeholder="Salon UPI ID (e.g., name@upi)">
        <input id="advAmt" type="number" min="0" value="50" placeholder="Min Advance ‚Çπ">

        <input id="pin" placeholder="Set Owner PIN (4‚Äì6 digits)" inputmode="numeric" maxlength="6">
      </div>

      <div class="sp"></div>
      <div class="muted" style="margin-bottom:8px">Services & Prices (‚Çπ)</div>
      <div class="row">
        <input id="pHaircut" type="number" placeholder="Haircut (‚Çπ)" value="120" min="0">
        <input id="pShave"   type="number" placeholder="Shave (‚Çπ)"   value="60" min="0">
        <input id="pBeard"   type="number" placeholder="Beard (‚Çπ)"   value="80" min="0">
        <input id="pFacial"  type="number" placeholder="Facial (‚Çπ)"  value="300" min="0">
      </div>
      <div class="sp"></div>
      <input id="wa" placeholder="WhatsApp Number (e.g., 91XXXXXXXXXX)">
      <div class="sp"></div>
      <button id="btnCreate" class="btn">Create Account</button>
      <div id="msg" class="muted" style="margin-top:10px"></div>
    </div>
  </section>

  <section id="list" class="wrap" style="margin-top:18px">
    <div class="h2" data-i18n="salonList">üîé Salon List</div>
    <div class="card">
      <div class="toolbar">
        <input id="qCity" placeholder="City / Area (live filter)">
        <select id="qService">
          <option value="">Any service</option>
          <option value="haircut">Haircut</option>
          <option value="shave">Shave</option>
          <option value="beard">Beard</option>
          <option value="facial">Facial</option>
        </select>
        <select id="qSort">
          <option value="name">Sort: Name</option>
          <option value="priceAsc">Price (low‚Üíhigh)</option>
          <option value="priceDesc">Price (high‚Üílow)</option>
          <option value="new">Newest</option>
          <option value="rating">Top Rated</option>
        </select>
        <input id="qText" placeholder="Search name/owner">
        <button id="btnSearch" class="btn">Search</button>
      </div>
    </div>
    <div class="sp"></div>
    <div id="listOut" class="list"></div>
  </section>

  <section id="detailPage" class="wrap hide" style="margin-top:18px">
    <button class="btn ghost back" id="backBtn">‚Üê <span data-i18n="back">Back</span></button>
    <div class="card" id="detailCard"></div>
  </section>

  <section id="profilePage" class="wrap hide" style="margin-top:18px">
    <div class="h2">üë§ <span data-i18n="profile">Customer Profile</span></div>
    <div class="card">
      <div class="row">
        <input id="meName" placeholder="Your Name">
        <input id="meMobile" placeholder="Mobile (10-digit)">
        <button id="saveMe" class="btn">Save</button>
      </div>
      <div class="sp"></div>
      <div class="h2">üóÇÔ∏è <span data-i18n="myBookings">My Bookings</span></div>
      <div style="overflow:auto">
        <table id="myBkTable"><thead><tr><th>Date</th><th>Time</th><th>Salon</th><th>Service</th><th>Notes</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <section id="adminPage" class="wrap hide" style="margin-top:18px">
    <div class="h2">üìä Admin Dashboard</div>
    <div class="kpis" id="kpiRow"></div>
    <div class="sp"></div>

    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="h2">üïò Recent Bookings</div>
          <div class="row">
            <button id="exportCsv" class="btn small">‚¨áÔ∏è Export CSV</button>
            <button id="clearBookings" class="btn ghost small">üóëÔ∏è Clear Bookings</button>
          </div>
        </div>
        <div class="sp"></div>
        <div style="overflow:auto">
          <table id="bkTable">
            <thead>
              <tr><th>Date</th><th>Time</th><th>Salon</th><th>Service</th><th>Customer</th><th>Notes</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="h2">üèôÔ∏è Top Cities</div>
        <table id="cityTable"><thead><tr><th>City</th><th>Salons</th></tr></thead><tbody></tbody></table>
      </div>

      <div class="card">
        <div class="h2">‚≠ê Top Rated Salons</div>
        <table id="topRated"><thead><tr><th>Salon</th><th>Avg ‚òÖ</th><th>Ratings</th></tr></thead><tbody></tbody></table>
      </div>

      <div class="card">
        <div class="h2">üî• Most Booked Salons</div>
        <table id="topBooked"><thead><tr><th>Salon</th><th>Bookings</th></tr></thead><tbody></tbody></table>
      </div>

      <div class="card">
        <div class="h2">üìà SEO Dashboard</div>
        <div class="row" style="justify-content:space-between">
          <div class="muted">Search queries & most viewed salons</div>
          <button id="seoClear" class="btn ghost small">üßπ Clear SEO logs</button>
        </div>
        <div class="sp"></div>
        <div style="display:grid;gap:10px">
          <div>
            <div class="h2">üîç Top Queries</div>
            <table id="seoQuery"><thead><tr><th>Query</th><th>Count</th></tr></thead><tbody></tbody></table>
          </div>
          <div>
            <div class="h2">üëÅÔ∏è Most Viewed Salons</div>
            <table id="seoViews"><thead><tr><th>Salon</th><th>Views</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>

    </div>
  </section>

  <footer>Made with ‚ù§Ô∏è by Kamlesh Banjare ‚Ä¢ Free hosting on GitHub Pages</footer>

  <dialog id="loginDialog" aria-labelledby="loginTitle">
    <div class="modal-head">
      <div id="loginTitle" style="font-weight:900">Owner Login</div>
      <button class="x" id="closeLogin">‚úñ</button>
    </div>
    <div class="modal-body" style="display:grid;gap:12px">
      <input id="loginMobile" placeholder="Registered Mobile (10 or 91+10)" inputmode="numeric" maxlength="12">
      <input id="loginPin" placeholder="PIN (4‚Äì6 digits)" inputmode="numeric" maxlength="6">
      <button id="doLogin" class="btn">Login</button>
      <div id="loginMsg" class="muted"></div>
    </div>
  </dialog>

  <script>
    /* ========= Storage Keys ========= */
    const LS="salon-india:v6";           // salons
    const LSB="salon-india:bookings";    // bookings by salon/date
    const SESS="salon-india:session";    // owner session
    const ME="si:me";                    // customer profile (local)
    const LANGK="si:lang";               // language pref
    const SEOQ="si:seo:queries";         // {query:count}
    const SEOV="si:seo:views";           // {slug:count}

    // load/save helpers (key-based)
    const load = k => {
      try { return JSON.parse(localStorage.getItem(k) || "null"); }
      catch(e){ return null; }
    };
    const save = (k,v) => {
      try { localStorage.setItem(k, JSON.stringify(v)); } catch(e){}
    };

    const loadSalons = ()=>load(LS)??[];
    const saveSalons = v=>save(LS,v);
    const loadBk = ()=>load(LSB)??{};
    const saveBk = v=>save(LSB,v);
    const setSession = v=>save(SESS,v||{});
    const getSession = ()=>load(SESS)??{};
    const getMe = ()=>load(ME)??{name:"",mobile:"",bookings:[]};
    const setMe = v=>save(ME,v);
    const getLang = ()=>localStorage.getItem(LANGK)||"hi";
    const setLang = v=>localStorage.setItem(LANGK,v);

    /* ========= Helpers ========= */
    const $ = s => document.querySelector(s);
    const toast=(msg)=>{const t=document.createElement('div');t.className='toast';t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),2400);};
    const show = el => el && el.classList && el.classList.remove('hide');
    const hide = el => el && el.classList && el.classList.add('hide');
    const numOrNull = v => { const n=parseFloat(v); return Number.isFinite(n)?n:null; };

    // Theme ASAP
    (function(){const pref=localStorage.getItem('theme'); if(pref) document.documentElement.setAttribute('data-theme',pref);})();
    $('#themeBtn')?.addEventListener('click',()=>{
      const cur=document.documentElement.getAttribute('data-theme');
      const next=cur==='light'?'dark':'light';
      document.documentElement.setAttribute('data-theme',next);
      localStorage.setItem('theme',next);
    });

    /* ========= i18n (EN/HI) ========= */
    const I18N={
      hi:{
        brand:'Salon India',
        heroTitle:'Register ‚Ä¢ List ‚Ä¢ Book ‚Äî Premium, fast & free',
        heroSub:'Owners apna page register karein, prices set karein, aur customers WhatsApp/UPI se booking karein.',
        aboutTitle:'Bharat ke salon owners ke liye smart platform',
        aboutSub:'Koi complicated app nahi. Sirf form bhariye aur turant listing ready.',
        feat1:'Short link, prices, ratings, photo, WhatsApp',
        feat2:'Live City filter & Owner login',
        feat3:'Detail Page + Calendar + üìç Maps',
        feat4:'PWA Install (Android App)',
        feat5:'UPI Advance Payment',
        feat6:'Customer Profile & Booking history',
        feat7:'SEO Dashboard',
        ctaRegister:'+ Register',
        ctaBrowse:'üîé Browse',
        ownerRegister:'üìù Owner Register',
        salonList:'üîé Salon List',
        back:'Back',
        profile:'Customer Profile',
        myBookings:'My Bookings',
      },
      en:{
        brand:'Salon India',
        heroTitle:'Register ‚Ä¢ List ‚Ä¢ Book ‚Äî Premium, fast & free',
        heroSub:'Owners register your page, set prices, customers book via WhatsApp/UPI.',
        aboutTitle:'Smart platform for salon owners in India',
        aboutSub:'No complicated app. Just a form & your listing is ready.',
        feat1:'Short link, prices, ratings, photo, WhatsApp',
        feat2:'Live City filter & Owner login',
        feat3:'Detail Page + Calendar + üìç Maps',
        feat4:'PWA Install (Android App)',
        feat5:'UPI Advance Payment',
        feat6:'Customer Profile & Booking history',
        feat7:'SEO Dashboard',
        ctaRegister:'+ Register',
        ctaBrowse:'üîé Browse',
        ownerRegister:'üìù Owner Register',
        salonList:'üîé Salon List',
        back:'Back',
        profile:'Customer Profile',
        myBookings:'My Bookings',
      }
    };
    function applyLang(){
      const dict=I18N[getLang()]||I18N.hi;
      document.querySelectorAll('[data-i18n]').forEach(n=>{
        const key=n.getAttribute('data-i18n'); if(dict[key]) n.textContent=dict[key];
      });
      document.documentElement.lang=getLang();
    }
    $('#langBtn').addEventListener('click', ()=>{ setLang(getLang()==='hi'?'en':'hi'); applyLang(); });

    /* ========= Slugs ========= */
    function makeSlug(str){ return (str||"").toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').replace(/-{2,}/g,'-').slice(0,50); }
    function slugExists(s){ try{ return loadSalons().some(x => (x.slug||"").toLowerCase()===(s||"").toLowerCase()); }catch(e){ return false; } }
    const salonName=$('#salonName'), slugInput=$('#slug'), slugHelp=$('#slugHelp'); let slugManuallyEdited=false;
    if(salonName&&slugInput){
      salonName.addEventListener('input',()=>{ if(!slugManuallyEdited){ slugInput.value=makeSlug(salonName.value); validateSlug(); }});
      slugInput.addEventListener('input',()=>{ slugManuallyEdited=true; slugInput.value=makeSlug(slugInput.value); validateSlug(); });
    }
    function validateSlug(){
      if(!slugInput) return;
      const s=slugInput.value; const bad=!/^[a-z0-9-]{3,}$/.test(s); const taken=slugExists(s);
      if(bad){ slugInput.style.borderColor='var(--err)'; slugHelp.textContent='Slug me sirf a-z, 0-9 aur ‚Äú-‚Äù (min 3 chars).'; slugHelp.style.color='var(--err)'; }
      else if(taken){ slugInput.style.borderColor='var(--warn)'; slugHelp.textContent='Ye short link already use me hai. Koi aur try karein.'; slugHelp.style.color='var(--warn)'; }
      else { slugInput.style.borderColor='var(--ok)'; slugHelp.textContent='Perfect! Ye short link available hai.'; slugHelp.style.color='var(--ok)'; }
    }

    /* ========= Photo preview ========= */
    const fileEl = $('#photo'), prevEl = $('#photoPrev'); let photoDataURL = "";
    fileEl?.addEventListener('change', (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      const r=new FileReader();
      r.onload=()=>{ photoDataURL=r.result||""; prevEl.src=photoDataURL; prevEl.classList.remove('hide'); };
      r.readAsDataURL(f);
    });

    /* ========= GPS ========= */
    $('#gpsBtn')?.addEventListener('click', ()=>{
      if(!navigator.geolocation){ toast('GPS supported nahi hai'); return; }
      navigator.geolocation.getCurrentPosition(
        pos=>{ $('#lat').value=pos.coords.latitude.toFixed(6); $('#lng').value=pos.coords.longitude.toFixed(6); toast('Location set ‚úÖ'); },
        err=>{ toast('GPS error: '+err.message); },
        {enableHighAccuracy:true, timeout:12000}
      );
    });

    /* ========= Register ========= */
    function showMsg(t,type){ const el=$("#msg"); if(el) { el.textContent=t; el.style.color= type==="ok"?"var(--ok)":"var(--warn)"; } toast(t); }
    $('#btnCreate').addEventListener('click', ()=>{
      const salon={
        id:Date.now(),
        owner: $('#owner').value.trim(),
        mobile: $('#mobile').value.trim(),
        name: $('#salonName').value.trim(),
        city: ($('#city').value.trim()||"").toLowerCase(),
        slug: ($('#slug').value.trim()||"").toLowerCase(),
        price: {
          haircut: +($('#pHaircut').value||0),
          shave:   +($('#pShave').value||0),
          beard:   +($('#pBeard').value||0),
          facial:  +($('#pFacial').value||0)
        },
        wa: ($('#wa').value||'').trim().replace(/^\+/, ''),
        pin: ($('#pin').value||"").trim(),
        photo: photoDataURL||"",
        rSum: 0, rCount: 0,
        loc: {
          address: ($('#addr').value||'').trim(),
          lat: numOrNull($('#lat').value),
          lng: numOrNull($('#lng').value)
        },
        upi: ($('#upi').value||'').trim(),
        advance: Math.max(0, +($('#advAmt').value||0))
      };

      const is10=/^\d{10}$/.test(salon.mobile);
      const is91=/^91\d{10}$/.test(salon.mobile);
      if(!salon.owner || !(is10||is91) || !salon.name || !salon.city){
        showMsg("‚ö†Ô∏è Owner, 10-digit mobile (ya 91+10), Salon name aur City zaroori hain.","warn"); return;
      }
      // ... Register logic (line ~510)
let waNum = ($('#wa').value||'').trim().replace(/^\+/, ''); // Remove leading '+'
if(waNum.length === 10) waNum = '91' + waNum; // Add '91' if it's 10 digits
// ... then use waNum to store in salon object

      if(!salon.pin || !/^\d{4,6}$/.test(salon.pin)){ showMsg("‚ö†Ô∏è PIN 4‚Äì6 digit ka set karein.","warn"); return; }

      if(!salon.slug) salon.slug=makeSlug(salon.name);
      if(!/^[a-z0-9-]{3,}$/.test(salon.slug)){ showMsg("‚ö†Ô∏è Slug galat hai.","warn"); return; }
      if(slugExists(salon.slug)){ showMsg("‚ö†Ô∏è Ye short link (slug) pehle se use me hai.","warn"); return; }

      const all=loadSalons(); all.push(salon); saveSalons(all);
      showMsg("‚úÖ Salon add ho gaya! (Salon List me dekh sakte ho)","ok");
      ['owner','mobile','salonName','city','slug','wa','pin','pHaircut','pShave','pBeard','pFacial','addr','lat','lng','upi','advAmt'].forEach(id=>{const el=document.getElementById(id); if(el) el.value='';});
      photoDataURL=""; if(prevEl){ prevEl.classList.add('hide'); prevEl.src=""; }
      slugManuallyEdited=false; renderList();
    });

    /* ========= List / Search / Sort ========= */
    const outEl = $('#listOut');
    const minPrice = s => { const v=Object.values(s.price||{}).filter(n=>typeof n==='number'&&n>0); return v.length?Math.min(...v):0; };
    const avgRating = s => s.rCount? (s.rSum/s.rCount) : 0;

    function renderItem(s){
      const el=document.createElement('div'); el.className='item';
      const waBase=s.wa?`https://wa.me/${s.wa}`:'';
      const isOwner=(getSession().id===s.id);

      el.innerHTML = `
        <div style="display:flex;gap:12px;align-items:center">
          ${s.photo?`<img class="thumb" src="${s.photo}" alt="${s.name}">`:''}
          <div style="flex:1">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
              <div>
                <div style="font-weight:900;font-size:18px">üíà ${s.name}</div>
                <div class="muted">Owner: ${s.owner} ‚Ä¢ City: ${s.city} ‚Ä¢ ‚≠ê ${avgRating(s).toFixed(1)} (${s.rCount})</div>
              </div>
              <div class="row">
                <button class="btn" data-open="${s.slug||s.id}">View / Book</button>
                ${waBase?`<a class="btn ghost" target="_blank" rel="noopener" href="${waBase}?text=${encodeURIComponent('Namaste '+s.name+' me booking karna hai.')}" title="WhatsApp">WhatsApp</a>`:''}
              </div>
            </div>
          </div>
        </div>
        <div class="badges">
          <span class="tag">‚úÇÔ∏è Haircut ‚Çπ${s.price?.haircut||'-'}</span>
          <span class="tag">ü™í Shave ‚Çπ${s.price?.shave||'-'}</span>
          <span class="tag">üßî Beard ‚Çπ${s.price?.beard||'-'}</span>
          <span class="tag">üíÜ Facial ‚Çπ${s.price?.facial||'-'}</span>
          ${s.loc?.lat&&s.loc?.lng?`<span class="tag">üìç On Map</span>`:''}
          ${s.upi?`<span class="tag">üí≥ UPI</span>`:''}
          ${isOwner?`<span class="tag">üõ†Ô∏è Owner</span>`:''}
        </div>
      `;
      el.querySelector('[data-open]')?.addEventListener('click',e=>{
        const slug=e.currentTarget.getAttribute('data-open'); location.hash=`#s/${encodeURIComponent(slug)}`;
      });
      return el;
    }

    function renderList(){
      const qCity=(($('#qCity')?.value)||'').trim().toLowerCase();
      const qSrv=(($('#qService')?.value)||'').trim();
      const qText=(($('#qText')?.value)||'').trim().toLowerCase();
      const qSort=(($('#qSort')?.value)||'name');

      let rows=loadSalons().filter(s=>{
        const byCity=qCity ? (s.city||'').includes(qCity) : true;
        const byText=qText ? ((s.name||'').toLowerCase().includes(qText) || (s.owner||'').toLowerCase().includes(qText)) : true;
        const bySrv=qSrv ? ((s.price||{})[qSrv]>0) : true;
        return byCity && byText && bySrv;
      });

      rows.sort((a,b)=>{
        if(qSort==='priceAsc') return minPrice(a)-minPrice(b);
        if(qSort==='priceDesc')return minPrice(b)-minPrice(a);
        if(qSort==='new')     return b.id-a.id;
        if(qSort==='rating')  return avgRating(b)-avgRating(a);
        return (a.name||'').localeCompare(b.name||'');
      });

      outEl.innerHTML='';
      if(!rows.length){ outEl.innerHTML=`<div class="card muted">Koi salon nahi mila. Filters change karein ya pehle Register karein.</div>`; return; }
      rows.forEach(s=>outEl.appendChild(renderItem(s)));
    }
    $('#btnSearch')?.addEventListener('click',()=>{ renderList(); logQuery(); });
    $('#qCity')?.addEventListener('input',renderList);

    /* ========= Booking calendar ========= */
    const workStart=9, workEnd=19, stepMin=30;
    const bookedSetFor = (salonId, dateStr) => new Set((loadBk()[salonId]?.[dateStr]||[]).map(x=>x.time));
    function addBookingRecord(salonId, dateStr, rec){
      const all=loadBk();
      if(!all[salonId]) all[salonId]={};
      if(!all[salonId][dateStr]) all[salonId][dateStr]=[];
      all[salonId][dateStr].push(rec);
      saveBk(all);
    }

    function buildSlotGrid(dateStr, bookedSet){
      const wrap=document.createElement('div'); wrap.className='slots';
      const mk=n=>n.toString().padStart(2,'0');
      // create start time date object (local)
      let t=new Date(dateStr+'T'+mk(workStart)+':00:00');
      const end=new Date(dateStr+'T'+mk(workEnd)+':00:00');
      while(t<end){
        const hh=mk(t.getHours()), mm=mk(t.getMinutes());
        const key=`${hh}:${mm}`;
        const b=document.createElement('button');
        b.type='button';
        b.className='slot'+(bookedSet.has(key)?' dis':'');
        b.textContent=key;
        b.dataset.time=key;
        wrap.appendChild(b);
        // increment by step
        t=new Date(t.getTime()+stepMin*60000);
      }
      return wrap;
    }

    /* ========= Detail PAGE ========= */
    const detailWrap = $('#detailPage');
    const detailCard = $('#detailCard');

    const label = k => ({haircut:'Haircut',shave:'Shave',beard:'Beard',facial:'Facial'})[k]||k;
    const avg = s => s.rCount? (s.rSum/s.rCount) : 0;
    // FIX 3.1: Correcting Google Maps Embed URL
    const mapIframe = (lat,lng,zoom=15) => {
    const mapIframe = (lat,lng,zoom=15) => {
  // ‚úÖ Correct Google Maps embed URL format
  const src=`https://maps.google.com/maps?q=${lat},${lng}&z=${zoom}&output=embed`;
  return `<div class="mapBox"><iframe width="100%" height="260" style="border:0" loading="lazy" allowfullscreen referrerpolicy="no-referrer-when-downgrade" src="${src}"></iframe></div>`;
};
       }

    function upiLink(upi, pn, amt, note){
      const qp = new URLSearchParams({pa:upi,pn,am:String(amt||0),cu:'INR',tn:note});
      return `upi://pay?${qp.toString()}`;
    }

    // --- PWA Notification Helper ---
    function pushNotif(tag, title, body, icon='/icon-192x192.png'){
      if ('Notification' in window && Notification.permission === 'granted' && 'serviceWorker' in navigator) {
        navigator.serviceWorker.ready.then(reg => {
          reg.showNotification(title, { body, tag, icon, vibrate: [200, 100, 200] });
        });
      } else if ('Notification' in window && Notification.permission !== 'denied') {
        Notification.requestPermission().then(p => {
          if (p === 'granted' && 'serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(reg => {
              reg.showNotification(title, { body, tag, icon, vibrate: [200, 100, 200] });
            });
          }
        });
      }
    }
    // -------------------------------

    function renderDetailPage(slugOrId){
      const a=loadSalons();
      const s=a.find(x=>(x.slug||x.id.toString())===slugOrId);
      if(!s){ detailCard.innerHTML='<div class="card">Salon nahi mila.</div>'; return; }

      // SEO view log
      const views = load(SEOV)??{}; const key=s.slug||String(s.id); views[key]=(views[key]||0)+1; save(SEOV,views);

      hide($('#home')); hide($('#about')); hide($('#register')); hide($('#list')); hide($('#adminPage')); hide($('#profilePage')); show(detailWrap);

      const waBase=s.wa?`https://wa.me/${s.wa}`:'';
      const shareUrl=`${location.origin}${location.pathname}#s/${encodeURIComponent(s.slug||s.id)}`;
      const hasLoc = Number.isFinite(s.loc?.lat) && Number.isFinite(s.loc?.lng);
      // FIX 3.2 & 3.3: Correcting Google Maps View/Direction Links
     const gLink  = hasLoc ? `https://maps.google.com/?q=${s.loc.lat},${s.loc.lng}` : ''; // View Map
const dirLink= hasLoc ? `https://maps.google.com/maps?daddr=${s.loc.lat},${s.loc.lng}` : ''; // Get Directions
 
      detailCard.innerHTML = `
        <div class="header">
          ${s.photo?`<img class="thumb" src="${s.photo}" alt="${s.name}">`:''}
          <div>
            <div class="h2" style="font-size:22px">${s.name}</div>
            <div class="muted">Owner: ${s.owner} ‚Ä¢ ${s.city} ‚Ä¢ ‚≠ê ${avg(s).toFixed(1)} (${s.rCount})</div>
            ${s.loc?.address?`<div class="muted">üìç ${s.loc.address}</div>`:''}
            <div class="row" style="margin-top:8px">
              ${waBase?`<a class="btn" target="_blank" rel="noopener" href="${waBase}?text=${encodeURIComponent('Namaste '+s.name+' me booking karna hai.')}" title="WhatsApp">WhatsApp</a>`:''}
              <button class="btn ghost" id="copyLink">üîó Copy Link</button>
              ${hasLoc?`<a class="btn ghost" target="_blank" rel="noopener" href="${gLink}">üó∫Ô∏è Open Map</a>`:''}
            </div>
          </div>
        </div>

        <div class="sp"></div>
        <div class="prices">
          <span class="tag">‚úÇÔ∏è Haircut ‚Çπ${s.price?.haircut||'-'}</span>
          <span class="tag">ü™í Shave ‚Çπ${s.price?.shave||'-'}</span>
          <span class="tag">üßî Beard ‚Çπ${s.price?.beard||'-'}</span>
          <span class="tag">üíÜ Facial ‚Çπ${s.price?.facial||'-'}</span>
        </div>

        ${hasLoc?`<div class="sp"></div><div class="h2">üìç Location</div>${mapIframe(s.loc.lat,s.loc.lng)}<div class="row" style="margin-top:8px"><a class="btn" target="_blank" rel="noopener" href="${dirLink}">üöó Get Directions</a></div>`:''}

        <div class="sp"></div>
        <div class="h2">üìÖ Book a time</div>
        <div class="row">
          <select id="svcSel">${Object.entries(s.price).filter(([k,v])=>v>0).map(([k,v])=>`<option value="${k}" data-price="${v}">${label(k)} ‚Äî ‚Çπ${v}</option>`).join('')}</select>
          <input id="dateSel" type="date">
        </div>
        <div class="sp"></div>
        <div id="slotsArea"></div>
        <div class="sp"></div>
        <div class="row">
          <input id="bkName" placeholder="Your Name">
          <input id="bkNotes" placeholder="Notes (optional)">
        </div>
        <div class="sp"></div>
        <div class="row">
          <button class="btn" id="confirmBk"${waBase?'':' disabled'}>${waBase?'Send WhatsApp Booking':'WhatsApp not set'}</button>
          <button class="btn ghost" id="copyBk">Copy Booking Text</button>
          ${s.upi?`<button class="btn" id="payAdv">üí≥ Pay Advance</button>`:''}
        </div>

        <div class="sp"></div>
        <div class="h2">‚≠ê Rate this salon</div>
        <div id="rateRow">${[1,2,3,4,5].map(n=>`<span class="star" data-rate="${n}">‚òÜ</span>`).join('')}</div>
      `;

      // -------- GUARD: no service options -> disable actions & exit (fix) --------
      const svcSelEl = document.getElementById('svcSel');
      if (!svcSelEl || !svcSelEl.options.length) {
        const slotsArea = document.getElementById('slotsArea');
        if (slotsArea) slotsArea.innerHTML = '<div class="muted">Is salon ne abhi services ke prices set nahi kiye.</div>';
        ['confirmBk','copyBk','payAdv'].forEach(id=>{ const b=document.getElementById(id); if(b) b.disabled=true; });
        const dateSel = document.getElementById('dateSel');
        if (dateSel) dateSel.disabled = true;
        return;
      }
      // -------------------------------------------------------------------------

      // Prefill from profile
      const me=getMe(); if(me.name) $('#bkName').value=me.name;

      $('#copyLink').addEventListener('click',()=>navigator.clipboard.writeText(shareUrl).then(()=>toast('Link copied')));

      // init date + slots
      const dateEl=$('#dateSel'); const slotsArea=$('#slotsArea');
      const d=new Date(); const min=d.toISOString().slice(0,10);
      if(dateEl){ dateEl.min=min; dateEl.value=min; }
      let selectedTime="";

      function drawSlots(){
        selectedTime="";
        const set=bookedSetFor(s.id, dateEl.value);
        slotsArea.innerHTML="";
        const grid=buildSlotGrid(dateEl.value,set);
        slotsArea.appendChild(grid);
        grid.querySelectorAll('.slot').forEach(btn=>{
          btn.addEventListener('click',()=>{
            grid.querySelectorAll('.slot').forEach(b=>b.classList.remove('sel'));
            btn.classList.add('sel'); selectedTime=btn.dataset.time;
          });
        });
      }
      if(dateEl){ drawSlots(); dateEl.addEventListener('change',drawSlots); }

      // ---- safer price reader (fix) ----
      function currSvcPrice(){
        const
       // ---- safer price reader (fix) ----
      function currSvcPrice(){
        const sel = document.getElementById('svcSel');
        const opt = sel && sel.selectedOptions && sel.selectedOptions[0];
        const p = +(opt?.dataset?.price || 0);
        return Number.isFinite(p) ? p : 0;
      }
      // ----------------------------------

      function bookingText(){
        const svc=label($('#svcSel').value);
        const nm=($('#bkName').value||'').trim()||'Customer';
        const notes=($('#bkNotes').value||'').trim();
        return `Namaste ${s.name}!\nMain ${nm} ${svc} ke liye ${dateEl.value} ${selectedTime} par booking karna chahta/chahti hu. ${notes?('Notes: '+notes):''}\n\n‚Äì via Salon India`;
      }

      function saveToMyHistory(rec){
        const me=getMe();
        me.bookings.unshift(rec);
        me.bookings=me.bookings.slice(0,100);
        if(!me.name) me.name=rec.name||'';
        setMe(me);
      }

      $('#confirmBk').addEventListener('click',()=>{
        if(!selectedTime){ toast('Time slot select karein'); return; }
        const rec={ time:selectedTime, date:dateEl.value, service:$('#svcSel').value, price:currSvcPrice(), name:($('#bkName').value||'').trim()||'Customer', notes:($('#bkNotes').value||'').trim(), createdAt:Date.now(), salon:s.name };
        addBookingRecord(s.id, dateEl.value, rec);
        saveToMyHistory({...rec, salonId:s.id});
        toast('Booking saved ‚úÖ');
        // FIX: PWA Notification trigger
        pushNotif(String(s.id), 'New Booking!', `‚úÇÔ∏è ${rec.service} for ${rec.name} on ${rec.date} ${rec.time}`);
        // END OF FIX
        drawSlots();
        if(s.wa) window.open(`https://wa.me/${s.wa}?text=${encodeURIComponent(bookingText())}`,'_blank');
      });
      $('#copyBk').addEventListener('click',()=>{
        if(!selectedTime){ toast('Time slot select karein'); return; }
        navigator.clipboard.writeText(bookingText()).then(()=>toast('Booking text copied')).catch(()=>toast('Copied text'));
      });

      // Advance Payment (UPI)
      if($('#payAdv')){
        $('#payAdv').addEventListener('click',()=>{
          if(!selectedTime){ toast('Time slot select karein'); return; }
          const svc=label($('#svcSel').value);
          const price=currSvcPrice();
          const adv= s.advance>0 ? s.advance : Math.max(10, Math.round(price*0.2)); // at least ‚Çπ10
          const note=`Advance for ${svc} on ${dateEl.value} ${selectedTime}`;
          const link=upiLink(s.upi, s.name, adv, note);
          // open UPI intent (if supported)
          location.href=link;
        });
      }

      // ratings
      [...document.querySelectorAll('#rateRow .star')].forEach(st=>{
        st.addEventListener('click',()=>{
          const r=parseInt(st.getAttribute('data-rate'));
          const arr=loadSalons(); const i=arr.findIndex(x=>x.id===s.id);
          if(i>-1){ arr[i].rSum += r; arr[i].rCount += 1; saveSalons(arr); toast(`Thanks! Rated ${r}‚òÖ`); renderDetailPage(slugOrId); }
        });
      });
    }

    // Back
    $('#backBtn').addEventListener('click',()=>{
      location.hash="#list";
      hide($('#detailPage')); hide($('#adminPage')); hide($('#profilePage')); show($('#home')); show($('#about')); show($('#register')); show($('#list'));
      renderList();
    });

    /* ========= PROFILE ========= */
    function renderProfile(){
      hide($('#home')); hide($('#about')); hide($('#register')); hide($('#list')); hide($('#detailPage')); hide($('#adminPage')); show($('#profilePage'));
      const me=getMe();
      $('#meName').value=me.name||'';
      $('#meMobile').value=me.mobile||'';
      const tbody=$('#myBkTable tbody'); if(!tbody) return; tbody.innerHTML='';
      me.bookings.forEach(b=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${b.date}</td><td>${b.time}</td><td>${b.salon||''}</td><td>${label(b.service)}</td><td>${b.notes||''}</td>`;
        tbody.appendChild(tr);
      });
    }
    $('#saveMe').addEventListener('click',()=>{
      const me=getMe();
      me.name=($('#meName').value||'').trim();
      const m=($('#meMobile').value||'').trim();
      if(m && !/^\d{10}$/.test(m)){ toast('Mobile 10-digit daaliye'); return; }
      me.mobile=m; setMe(me); toast('Saved ‚úÖ');
    });

    /* ========= ADMIN ========= */
    const kpiRow = $('#kpiRow');
    function flattenBookings(){
      const map=loadBk(); const salons=loadSalons();
      const out=[];
      Object.entries(map).forEach(([sid,dates])=>{
        const salon=salons.find(s=>s.id===+sid);
        Object.entries(dates).forEach(([date,arr])=>{
          arr.forEach(rec=>{
            out.push({
              salonId:+sid,
              salon: salon?.name||'Unknown',
              city: salon?.city||'',
              service: rec.service,
              date: rec.date||date,
              time: rec.time,
              name: rec.name||'',
              notes: rec.notes||'',
              createdAt: rec.createdAt||Date.now()
            });
          });
        });
      });
      out.sort((a,b)=>b.createdAt-a.createdAt);
      return out;
    }

    function fillTable(tbody, rows, cols){
      if(!tbody) return;
      tbody.innerHTML='';
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        cols.forEach(c=>{
          const td=document.createElement('td'); td.textContent=(typeof c==='function'?c(r):r[c])??''; tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function toCSV(rows){
      const headers=['date','time','salon','city','service','customer','notes'];
      const lines=[headers.join(',')];
      rows.forEach(r=>{
        const vals=[r.date,r.time,r.salon,r.city,r.service,(r.name||''),(r.notes||'')].map(v=>`"${String(v).replace(/"/g,'""')}"`);
        lines.push(vals.join(','));
      });
      return lines.join('\n');
    }

    function renderAdmin(){
      hide($('#home')); hide($('#about')); hide($('#register')); hide($('#list')); hide($('#detailPage')); hide($('#profilePage')); show($('#adminPage'));

      const salons=loadSalons();
      const bookings=flattenBookings();

      const withWA=salons.filter(s=>s.wa).length;
      const avgAll = salons.length ? (salons.reduce((a,s)=>a+(s.rCount? s.rSum/s.rCount : 0),0)/salons.length) : 0;

      const now=new Date();
      const todayStr=now.toISOString().slice(0,10);
      const startOfWeek=new Date(now); startOfWeek.setDate(now.getDate()-now.getDay());
      const weekStr=startOfWeek.toISOString().slice(0,10);

      const todayCount=bookings.filter(b=>b.date===todayStr).length;
      const weekCount=bookings.filter(b=>b.date>=weekStr).length;

      kpiRow.innerHTML='';
      [
        {label:'Total Salons', val:salons.length},
        {label:'With WhatsApp', val:withWA},
        {label:'Avg Rating', val:avgAll.toFixed(2)},
        {label:'Total Bookings', val:bookings.length},
        {label:'Today', val:todayCount},
        {label:'This Week', val:weekCount},
      ].forEach(k=>{
        const d=document.createElement('div'); d.className='kpi';
        d.innerHTML=`<div class="muted">${k.label}</div><div class="val">${k.val}</div>`;
        kpiRow.appendChild(d);
      });

      // Recent bookings
      fillTable($('#bkTable tbody'), bookings.slice(0,20), [
        'date','time','salon','service', r=>r.name, r=>r.notes
      ]);

      // Top cities
      const cityMap={}; salons.forEach(s=>{ if(!s.city) return; cityMap[s.city]=(cityMap[s.city]||0)+1; });
      const cityRows=Object.entries(cityMap).sort((a,b)=>b[1]-a[1]).map(([city,count])=>({city,count}));
      fillTable($('#cityTable tbody'), cityRows, ['city','count']);

      // Top rated
      const rated=salons.filter(s=>s.rCount>0).map(s=>({salon:s.name, avg:(s.rSum/s.rCount), count:s.rCount}));
      rated.sort((a,b)=>b.avg-a.avg);
      fillTable($('#topRated tbody'), rated.slice(0,10), [r=>r.salon, r=>r.avg.toFixed(2), 'count']);

      // Most booked
      const bkCountBySalon={}; bookings.forEach(b=>{ bkCountBySalon[b.salon]=(bkCountBySalon[b.salon]||0)+1; });
      const topBooked=Object.entries(bkCountBySalon).map(([salon,count])=>({salon,count})).sort((a,b)=>b.count-a.count);
      fillTable($('#topBooked tbody'), topBooked.slice(0,10), ['salon','count']);

      // SEO Dashboard
      const qmap = load(SEOQ)??{};
      const qrows = Object.entries(qmap).map(([q,c])=>({q,count:c})).sort((a,b)=>b.count-a.count).slice(0,20);
      fillTable($('#seoQuery tbody'), qrows, [r=>r.q, r=>r.count]);

      const vmap = load(SEOV)??{};
      const salonsBySlug={}; loadSalons().forEach(s=>salonsBySlug[s.slug||s.id]=s.name);
      const vrows = Object.entries(vmap).map(([k,c])=>({name:salonsBySlug[k]||k,count:c})).sort((a,b)=>b.count-a.count).slice(0,20);
      fillTable($('#seoViews tbody'), vrows, [r=>r.name, r=>r.count]);

      // Buttons
      $('#exportCsv').onclick=()=>{
        const csv=toCSV(bookings);
        const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download='salon-bookings.csv'; a.click(); URL.revokeObjectURL(url);
      };
      $('#clearBookings').onclick=()=>{
        if(confirm('Pakka? Sirf local bookings data clear hoga.')){ saveBk({}); toast('Bookings cleared'); renderAdmin(); }
      };
      $('#seoClear').onclick=()=>{
        if(confirm('SEO logs clear karein?')){ save(SEOQ,{}); save(SEOV,{}); toast('Cleared'); renderAdmin(); }
      };
    }

    /* ========= SEO Query Logger ========= */
    function logQuery(){
      const city=($('#qCity')?.value||'').trim().toLowerCase();
      const text=($('#qText')?.value||'').trim().toLowerCase();
      const key=[city,text].filter(Boolean).join(' | ');
      if(!key) return;
      const map=load(SEOQ)??{}; map[key]=(map[key]||0)+1; save(SEOQ,map);
    }

    /* ========= Router ========= */
    function router(){
      const h=(location.hash||'').replace(/^#!?/,'');
      const m=h.match(/^#s\/([^/]+)$/);
      if(m){ renderDetailPage(decodeURIComponent(m[1])); window.scrollTo({top:0,behavior:'smooth'}); return; }
      if(h==='#admin'){ renderAdmin(); window.scrollTo({top:0,behavior:'smooth'}); return; }
      if(h==='#profile'){ renderProfile(); window.scrollTo({top:0,behavior:'smooth'}); return; }
      hide($('#detailPage')); hide($('#adminPage')); hide($('#profilePage')); show($('#home')); show($('#about')); show($('#register')); show($('#list'));
    }
    window.addEventListener('hashchange',router);

    /* ========= Login (owner) ========= */
    const loginDlg=$('#loginDialog');
    $('#loginBtn').addEventListener('click',()=>loginDlg.showModal());
    $('#closeLogin').addEventListener('click',()=>loginDlg.close());
    $('#doLogin').addEventListener('click',()=>{
      const m=($('#loginMobile').value||'').trim().slice(-10);
      const p=($('#loginPin').value||'').trim();
      const a=loadSalons(); const s=a.find(x=>x.mobile===m && x.pin===p);
      if(s){ setSession({id:s.id, at:Date.now()}); $('#loginMsg').textContent='Logged in ‚úÖ'; loginDlg.close(); toast('Owner mode ON'); renderList();}
      else { $('#loginMsg').textContent='‚ùå Not found. Mobile/PIN check karein.'; }
    });

    /* ========= Analytics (local only) ========= */
    (function(){
      try{
        const KEY='si:analytics:v1';
        const data = JSON.parse(localStorage.getItem(KEY)||'{"visits":0,"last":""}');
        data.visits++; data.last=new Date().toISOString();
        localStorage.setItem(KEY, JSON.stringify(data));
      }catch(e){}
    })();

    /* ========= PWA Install ========= */
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault();
      deferredPrompt = e;
      const btn=document.createElement('button');
      btn.textContent='üì≤ Install Salon India App';
      btn.className='btn';
      btn.style.position='fixed'; btn.style.bottom='20px'; btn.style.right='20px'; btn.style.zIndex='9999';
      document.body.appendChild(btn);
      btn.addEventListener('click', async()=>{
        btn.style.display='none';
        if (!deferredPrompt) return;
        try {
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
        } finally {
          deferredPrompt = null;
        }
      });
    });
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(()=>{});
      });
    }

    /* ========= Init ========= */
    window.addEventListener('load',()=>{
      applyLang();
      renderList();
      router();
    });
  </script>
</body>
</html>
